<!DOCTYPE html>
<html>
<head>
    <title>Sprint Report</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                !function(){var Ext=window.Ext4||window.Ext;Ext.define("PepsiCo.apps.sprintreport.SprintMetricsRow",{extend:"Ext.panel.Panel",alias:"widget.sprintrepormetricsrow",cls:"sprint-report-metrics-row",width:612,height:150,title:"Sprint Metrics",border:1,collapsible:!0,layout:{type:"hbox",align:"stretch"},renderTo:Ext.getBody(),items:[{xtype:"panel",border:0,flex:1},{xtype:"panel",border:0,flex:1},{xtype:"panel",border:0,flex:1}]})}();
                !function(){var Ext=window.Ext4||window.Ext;Ext.define("PepsiCo.app.sprintreport.StoryMetricStories",{extend:"Ext.panel.Panel",alias:"widget.storymetricstories",cls:"story-metric-stories",width:250,height:130,storyCount:0,layout:{type:"table",columns:2},defaults:{bodyStyle:"padding:2px; font-size: 10px;"},items:[{html:"Story Count",cellCls:"metricHeader",bodyStyle:"color: blue; background-color: lightblue; font-size: 11px;"},{html:"Value",cellCls:"metricHeader",bodyStyle:"color: blue; background-color: lightblue; font-size: 11px;"},{html:"# Stories Planned:",cellCls:"metricData"},{html:this.storyCount,cellCls:"metricData"},{html:"# Stories Added:",cellCls:"metricData"},{cellCls:"metricData"},{html:"# Stories Accepted:",cellCls:"metricData"},{cellCls:"metricData"},{html:"# Stories Incomplete:",cellCls:"metricData"},{cellCls:"metricData"},{html:"% Stories Completed:",cellCls:"metricData"},{cellCls:"metricData"}],renderTo:Ext.getBody()})}();
                !function(){var Ext=window.Ext4||window.Ext;Ext.define("SprintReportApp",{extend:"Rally.app.App",componentCls:"app",requires:["PepsiCo.apps.sprintreport.SprintMetricsRow","Rally.ui.combobox.IterationComboBox","StoryMetricStories"],items:[{xtype:"container",itemId:"menuBar"},{xtype:"container",itemId:"reportheader"},{xtype:"container",itemId:"metricsrow"},{xtype:"container",itemId:"chartsrow"},{xtype:"container",itemId:"storiesrow"}],layout:{type:"vbox",align:"stretch"},stories:null,launch:function(){var iter=Ext.create("Rally.ui.combobox.IterationComboBox",{});this.down("#reportheader").add(iter),this.metricsRow=this.down("#metricsrow").add({xtype:"sprintrepormetricsrow"});var stories=Ext.create("Rally.data.wsapi.Store",{model:"userstory",autoLoad:!1,limit:"Infinity",filters:{property:"Iteration.Name",value:"Sprint n"},listeners:{load:this._onDataLoaded,scope:this},fetch:["ObjectID","FormattedID","Name","ScheduleState","PlanEstimate","Parent","Feature","Project","Notes","Tasks","Defects","State","Estimate","ToDo","Actuals"]});stories.load()},_onDataLoaded:function(store,data){var storyCount=0,storyPoints=0,storiesAccepted=0,storiesIncomplete=0,storiesPercent=0,storyPointsPercent=0,storyPointsAccepted=0;this.stories=this._loadStoryRecords(store,data),storyPoints=store.sum("PlanEstimate"),storyCount=store.count(),store.data.each(function(item,index,totalItems){"Accepted"===item.data.ScheduleState&&(storiesAccepted++,storyPointsAccepted+=item.data.PlanEstimate,console.log("Points accepted are %o",item.data))}),storiesIncomplete=storyCount-storiesAccepted,storiesPercent=storyCount>0?Math.round(storiesAccepted/storyCount*100):0,storyPointsPercent=storyPoints>0?Math.round(storyPointsAccepted/storyPoints*100):0,console.log("Stories: %o\nPoints: %o\nAccepted: %o\nA Points: %o\nPercent: %o and %o\n",storyCount,storyPoints,storiesAccepted,storyPointsAccepted,storiesPercent,storyPointsPercent),this._loadStoryMetrics(storyCount),this._loadFeatureStoryTable()},_loadFeatureStoryTable:function(){var records=this.stories;this.down("#storiesrow").add()},_loadStoryRecords:function(store,data){var records=_.map(data,function(record){var fName="",tCount=0;return null!==record.get("Feature")&&(fName=record.get("Feature").Name),null!==record.get("Tasks")&&(tCount=record.get("Tasks").Count),Ext.apply({FeatureName:fName,TaskCount:tCount},record.getData())});return records},_loadStoryMetrics:function(numStories){var storyTable=new StoryMetricStories({storyCount:numStories});this.metricsRow.items.getAt(0).add(storyTable)},_addDateFields:function(){var filterPanel=Ext.create("Ext.panel.Panel",{bodyPadding:5,width:300,title:"Filters",items:[{xtype:"datefield",fieldLabel:"Start date"},{xtype:"datefield",fieldLabel:"End date"}],renderTo:Ext.getBody()});this.down("#reportheader").add(filterPanel)}})}();

            Rally.launchApp('SprintReportApp', {
                name:"Sprint Report",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        td .metricHeader{color:blue;background-color:lightblue}.x-table-layout-cell.metricData panel-1022-innerCt{color:black;background-color:whitesmoke;font-size:11px}
    </style>
</head>
<body>
</body>
</html>
