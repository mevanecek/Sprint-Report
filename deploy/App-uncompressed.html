<!DOCTYPE html>
<html>
<head>
    <title>Sprint Report</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function () {
  var Ext = window.Ext4 || window.Ext;

  Ext.define('PepsiCo.apps.sprintreport.SprintMetricsRow', {
             extend: 'Ext.panel.Panel',
             alias: 'widget.sprintrepormetricsrow',
             cls: 'sprint-report-metrics-row',
             width: 612,
             height: 130,
             title: "Sprint Metrics",
             border: 1,
             collapsible: true,
             layout: {
                 type: 'hbox',
                 align: 'stretch'
             },
             renderTo: Ext.getBody(), // document.body,
             items: [{
                         xtype: 'panel',
                         title: 'Story Count',
                         border: 0,
                         flex: 1
                     },
                     {
                         xtype: 'panel',
                         title: 'Story Points',
                         border: 0,
                         flex: 1
                     },
                     {
                         xtype: 'panel',
                         title: 'Task Hours',
                         border: 0,
                         flex: 1
                     }]
             });
})();

                (function () {
    var Ext = window.Ext4 || window.Ext;
 
    Ext.define('StoryMetricStories', {
        extend: 'Ext.panel.Panel',
        alias: 'widget.storymetricstories',
        cls: 'story-metric-stories',
        width: 250,
        height: 130,
        layout: {
        type: 'table',
            // The total column count must be specified here
            columns: 2
        },
        defaults: {
               // applied to each contained panel
               bodyStyle: 'padding:2px'
        },
        items: [
               {
               html: 'Story Count',
               cellCls: 'metricHeader'
               },
               {
               html: 'Value',
               cellCls: 'metricHeader'
               },
               {
                html: '# Stories Planned:',
                cellCls: 'metricData'
               },
               {
                cellCls: 'metricData'
               },
               {
                html: '# Stories Added:',
                cellCls: 'metricData'
               },
               {
                cellCls: 'metricData'
               },
                {
                html: '# Stories Completed:',
                cellCls: 'metricData'
                },
                {
                cellCls: 'metricData'
                },
                {
                html: '# Stories Incomplete:',
                cellCls: 'metricData'
                },
                {
                cellCls: 'metricData'
                },
                {
                html: '% Stories Completed:',
                cellCls: 'metricData'
                },
                {
                cellCls: 'metricData'
                }
               ],
        renderTo: Ext.getBody()
    });
})();

                (function() {
    var Ext = window.Ext4 || window.Ext;
 
 
     Ext.define('SprintReportApp', {
        extend: 'Rally.app.App',
        componentCls: 'app',
        requires: [
                   'PepsiCo.apps.sprintreport.SprintMetricsRow',
                   'StoryMetricStories'
        ],
        items: [
            {
                xtype: 'container',
                itemId: 'menuBar'
            },
            {
                xtype: 'container',
                itemId: 'reportheader'
            },
            {
                xtype: 'container',
                itemId: 'metricsrow'
            },
            {
                xtype: 'container',
                itemId: 'chartsrow'
            },
            {
                xtype: 'container',
                itemId: 'storiesrow'
            }
        ],
        layout: {
            type: 'vbox',
            align: 'stretch'
        },
        stories: null,

        launch: function() {

            this.iterationCombobox = this.down('#reportheader').add({
                xtype: 'rallyiterationcombobox'
            });

            this.metricsRow = this.down('#metricsrow').add({
                xtype: 'sprintrepormetricsrow'
            });
               
            var storyTable = new StoryMetricStories();
            
                this.metricsRow.items.getAt(0).add(storyTable);
            
            this._addDateFields();
               
            Ext.create('Rally.data.wsapi.Store', {
                model: 'userstory',
                autoLoad: true,
                limit: "Infinity",
                listeners: {
                    load: this._onDataLoaded,
                    scope: this
                },
                fetch: ['ObjectID', 'FormattedID', 'Name', 'ScheduleState', 'PlanEstimate', 'Parent', 'Feature',
                        'Project', 'Notes', 'Tasks', 'Defects', 'State', 'Estimate', 'ToDo', 'Actuals']
            });

        //API Docs: https://help.rallydev.com/apps/2.1/doc/
        },

        _onDataLoaded: function(store, data) {
             this.stories = this._loadStoryRecords(store,data);
             this._loadFeatureStoryTable();
        },

    //    _loadFeatureStoryTable: function(store, data) {
        _loadFeatureStoryTable: function() {
            // var records = this._loadStoryRecords(store, data);
            var records = this.stories;

            this.down('#storiesrow').add({
                xtype: 'rallygrid',
                showPagingToolbar: false,
                showRowActionsColumn: false,
                editable: false,
                store: Ext.create('Rally.data.custom.Store', {
                    data: records
                }),
                columnCfgs: [
                    {
                        text: 'Feature',
                        width: 100,
                        dataIndex: 'FeatureName'
                    },
                    {
                        xtype: 'templatecolumn',
                        text: 'ID',
                        dataIndex: 'FormattedID',
                        width: 70,
                        tpl: Ext.create('Rally.ui.renderer.template.FormattedIDTemplate')
                    },
                    {
                        text: 'Name',
                        dataIndex: 'Name',
                        width: 150
    //                    flex: 1
                    },
                    {
                        text: 'Schedule State',
                        dataIndex: 'ScheduleState',
                        width: 90
                    },
                    {
                        text: 'Points',
                        dataIndex: 'PlanEstimate',
                        width: 55
                    },
                    {
                        text: 'Planned/Added',
                        dataIndex: 'Added',
                        width: 70
                    },
                    {
                        text: '# of Tasks',
                        dataIndex: 'TaskCount',
                        width: 55
                    },
                    {
                        text: '# of Defects',
                        dataIndex: 'Defects',
                        renderer: function(value) {
                            return value.Count;
                        },
                        width: 55
                    },
                    {
                        text: 'Review Feedback',
                        dataIndex: 'Notes',
                        width: 270
                    }
                ]
            });
        // --- end create the feature/story table
        },

        // Grab the stories from the Store, and apply any adjustments
        // or extra fields needed for the Stories table.
        _loadStoryRecords: function(store, data) {
             var records = _.map(data, function(record) {
                //Perform custom actions with the data here
                //Calculations, etc.
                                 
                var fName = "";
                var tCount = 0;
                                 
                // Make sure there is data for the record, before trying
                // to use it.
                if (record.get('Feature') !== null) {
                   fName = record.get('Feature').Name;
                }
                if (record.get('Tasks') !== null) {
                    tCount = record.get('Tasks').Count;
                }
                                 
                return Ext.apply({
                   FeatureName: fName,
                   TaskCount: tCount
                }, record.getData());
             });

             return records;
        },

        _addDateFields: function() {
            var filterPanel = Ext.create('Ext.panel.Panel', {
                bodyPadding: 5,  // Don't want content to crunch against the borders
                width: 300,
                title: 'Filters',
                items: [{
                    xtype: 'datefield',
                    fieldLabel: 'Start date'
                }, {
                    xtype: 'datefield',
                    fieldLabel: 'End date'
                }],
                renderTo: Ext.getBody()
            });
            this.down("#reportheader").add(filterPanel);
        }
    });
  })();


            Rally.launchApp('SprintReportApp', {
                name:"Sprint Report",
	            parentRepos:""
            });

        });
    </script>



    <style type="text/css">
        .app {
  /* Add app styles here */
}
.metricHeader {
  color: blue;
  background-color: lightblue;
}
.metricData {
  color: black;
  background-color: whitesmoke;
  font-size: 11px;
}

    </style>
</head>
<body>
</body>
</html>
